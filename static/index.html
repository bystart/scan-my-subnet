<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPèµ„æºæ‰«æç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.0.5/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-enter-active, .slide-leave-active { transition: all 0.3s ease; }
        .slide-enter-from { transform: translateY(-10px); opacity: 0; }
        .slide-leave-to { transform: translateY(10px); opacity: 0; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.2s ease; }
        .card-hover:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .pulse-animation { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .ip-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; }
        @media (max-width: 640px) { .ip-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.4rem; } }

        /* Toasté€šçŸ¥æ ·å¼ */
        .toast-enter-active { animation: slideInRight 0.3s ease; }
        .toast-leave-active { animation: slideOutRight 0.3s ease; }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Confirmå¯¹è¯æ¡†åŠ¨ç”» */
        .confirm-enter-active, .confirm-leave-active { transition: all 0.2s; }
        .confirm-enter-from, .confirm-leave-to { opacity: 0; transform: scale(0.9); }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" v-cloak>
        <!-- Toasté€šçŸ¥ç»„ä»¶ -->
        <div class="fixed top-4 right-4 z-50 space-y-2">
            <transition-group name="toast">
                <div v-for="toast in toasts" :key="toast.id"
                    :class="[
                        'px-4 py-2 rounded-lg shadow-lg flex items-center space-x-2 min-w-64',
                        toast.type === 'success' ? 'bg-green-500 text-white' :
                        toast.type === 'error' ? 'bg-red-500 text-white' :
                        toast.type === 'warning' ? 'bg-yellow-500 text-white' :
                        'bg-blue-500 text-white'
                    ]">
                    <i :class="[
                        'fas',
                        toast.type === 'success' ? 'fa-check-circle' :
                        toast.type === 'error' ? 'fa-times-circle' :
                        toast.type === 'warning' ? 'fa-exclamation-triangle' :
                        'fa-info-circle'
                    ]"></i>
                    <span class="flex-1 text-sm font-medium">{{ toast.message }}</span>
                    <button @click="removeToast(toast.id)" class="hover:opacity-75">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </transition-group>
        </div>

        <!-- Confirmç¡®è®¤å¯¹è¯æ¡† -->
        <transition name="fade">
            <div v-if="confirmDialog.show" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
                <transition name="confirm">
                    <div v-if="confirmDialog.show" class="bg-white rounded-lg shadow-xl p-5 max-w-sm w-full mx-4">
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-question-circle text-yellow-500 text-2xl mt-1"></i>
                            <div class="flex-1">
                                <h3 class="text-base font-bold text-gray-800 mb-2">ç¡®è®¤æ“ä½œ</h3>
                                <p class="text-sm text-gray-600">{{ confirmDialog.message }}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2 mt-4">
                            <button @click="confirmDialog.onConfirm(); confirmDialog.show = false"
                                class="flex-1 bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold py-2 rounded-lg transition">
                                ç¡®è®¤
                            </button>
                            <button @click="confirmDialog.onCancel(); confirmDialog.show = false"
                                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold py-2 rounded-lg transition">
                                å–æ¶ˆ
                            </button>
                        </div>
                    </div>
                </transition>
            </div>
        </transition>

        <!-- ç™»å½•é¡µé¢ -->
        <div v-if="!isLoggedIn" class="min-h-screen gradient-bg flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                <div class="text-center mb-6">
                    <!-- <i class="fas fa-network-wired text-purple-600 text-4xl mb-3"></i> -->
                    <h1 class="text-2xl font-bold text-gray-800">IPèµ„æºæ‰«æç³»ç»Ÿ</h1>
                    <p class="text-gray-500 text-sm mt-1">è¯·ç™»å½•ä»¥ç»§ç»­</p>
                </div>
                <form @submit.prevent="handleLogin">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-1">ç”¨æˆ·å</label>
                            <div class="relative">
                                <i class="fas fa-user absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                                <input v-model="loginForm.username" type="text" required
                                    class="w-full pl-9 pr-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                            </div>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-1">å¯†ç </label>
                            <div class="relative">
                                <i class="fas fa-lock absolute left-3 top-2.5 text-gray-400 text-sm"></i>
                                <input v-model="loginForm.password" type="password" required
                                    class="w-full pl-9 pr-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="è¯·è¾“å…¥å¯†ç ">
                            </div>
                        </div>
                    </div>
                    <button type="submit" :disabled="loginLoading"
                        class="w-full mt-4 gradient-bg text-white text-sm font-semibold py-2.5 rounded-lg hover:opacity-90 transition disabled:opacity-50">
                        <i v-if="loginLoading" class="fas fa-spinner fa-spin mr-1"></i>
                        {{ loginLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
                    </button>
                </form>
            </div>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div v-else>
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
            <nav class="gradient-bg shadow-lg">
                <div class="container mx-auto px-4 py-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-2">
                            <!-- <i class="fas fa-network-wired text-white text-2xl"></i> -->
                            <h1 class="text-white text-xl font-bold">IPèµ„æºæ‰«æç³»ç»Ÿ</h1>
                        </div>
                        <div class="flex space-x-2">
                            <button @click="showChangePasswordModal = true"
                                class="bg-white bg-opacity-20 text-white px-3 py-1.5 text-sm rounded-lg hover:bg-opacity-30 transition flex items-center space-x-1">
                                <i class="fas fa-key"></i>
                                <span class="hidden sm:inline">ä¿®æ”¹å¯†ç </span>
                            </button>
                            <button @click="showHostScanModal = true"
                                class="bg-orange-500 text-white px-3 py-1.5 text-sm rounded-lg font-semibold hover:bg-orange-600 transition flex items-center space-x-1">
                                <i class="fas fa-search"></i>
                                <span class="hidden sm:inline">ä¸»æœºæ‰«æ</span>
                            </button>
                            <button @click="showAddModal = true"
                                class="bg-white text-purple-600 px-3 py-1.5 text-sm rounded-lg font-semibold hover:bg-purple-50 transition flex items-center space-x-1">
                                <i class="fas fa-plus"></i>
                                <span class="hidden sm:inline">æ·»åŠ ç½‘æ®µ</span>
                            </button>
                            <button @click="handleLogout(false)"
                                class="bg-white bg-opacity-20 text-white px-3 py-1.5 text-sm rounded-lg hover:bg-opacity-30 transition">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="container mx-auto px-4 py-3">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                    <div class="bg-white rounded-lg shadow p-3 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs">ç½‘æ®µæ€»æ•°</p>
                                <p class="text-2xl font-bold text-gray-800">{{ stats.total_networks }}</p>
                            </div>
                            <div class="bg-blue-100 p-2 rounded-full">
                                <i class="fas fa-sitemap text-blue-600 text-lg"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-3 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs">IPæ€»æ•°</p>
                                <p class="text-2xl font-bold text-gray-800">{{ stats.total_ips }}</p>
                            </div>
                            <div class="bg-purple-100 p-2 rounded-full">
                                <i class="fas fa-server text-purple-600 text-lg"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-3 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs">åœ¨çº¿IP</p>
                                <p class="text-2xl font-bold text-green-600">{{ stats.active_ips }}</p>
                            </div>
                            <div class="bg-green-100 p-2 rounded-full">
                                <i class="fas fa-check-circle text-green-600 text-lg"></i>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-3 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-500 text-xs">ç¦»çº¿IP</p>
                                <p class="text-2xl font-bold text-red-600">{{ stats.inactive_ips }}</p>
                            </div>
                            <div class="bg-red-100 p-2 rounded-full">
                                <i class="fas fa-times-circle text-red-600 text-lg"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç½‘æ®µåˆ—è¡¨ -->
                <div class="space-y-3">
                    <div v-for="network in networks" :key="network.id" class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2">
                                        <h2 class="text-base font-bold text-gray-800">{{ network.name }}</h2>
                                        <span class="bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full text-xs font-semibold">{{ network.cidr }}</span>
                                    </div>
                                    <p v-if="network.description" class="text-gray-600 text-xs mt-1">{{ network.description }}</p>
                                </div>
                                <div class="flex space-x-1.5">
                                    <button @click="scanNetwork(network.id)" :disabled="scanStatus[network.id]?.status === 'scanning'"
                                        class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 text-xs rounded-lg transition flex items-center space-x-1 disabled:opacity-50">
                                        <i class="fas fa-sync-alt text-xs" :class="{'fa-spin': scanStatus[network.id]?.status === 'scanning'}"></i>
                                        <span>{{ scanStatus[network.id]?.status === 'scanning' ? 'æ‰«æä¸­' : 'æ‰«æ' }}</span>
                                    </button>
                                    <button @click="toggleNetworkDetail(network.id)"
                                        class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 text-xs rounded-lg transition">
                                        <i class="fas" :class="expandedNetworks.includes(network.id) ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                    </button>
                                    <button @click="deleteNetwork(network.id)"
                                        class="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 text-xs rounded-lg transition">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <transition name="slide">
                                <div v-if="expandedNetworks.includes(network.id) && networkDetails[network.id]">
                                    <div class="border-t pt-3 mt-3">
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex space-x-3 text-xs">
                                                <span class="text-gray-600">æ€»è®¡: <strong>{{ networkDetails[network.id].total_ips }}</strong></span>
                                                <span class="text-green-600">åœ¨çº¿: <strong>{{ networkDetails[network.id].active_ips }}</strong></span>
                                                <span class="text-red-600">ç¦»çº¿: <strong>{{ networkDetails[network.id].inactive_ips }}</strong></span>
                                            </div>
                                            <div class="flex space-x-1">
                                                <button @click="filterStatus[network.id] = 'all'"
                                                    :class="(filterStatus[network.id] || 'all') === 'all' ? 'bg-purple-500 text-white' : 'bg-gray-200 text-gray-700'"
                                                    class="px-2 py-0.5 rounded text-xs">å…¨éƒ¨</button>
                                                <button @click="filterStatus[network.id] = 'active'"
                                                    :class="filterStatus[network.id] === 'active' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700'"
                                                    class="px-2 py-0.5 rounded text-xs">åœ¨çº¿</button>
                                                <button @click="filterStatus[network.id] = 'inactive'"
                                                    :class="filterStatus[network.id] === 'inactive' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'"
                                                    class="px-2 py-0.5 rounded text-xs">ç¦»çº¿</button>
                                            </div>
                                        </div>
                                        <div class="ip-grid">
                                            <div v-for="ip in getFilteredIPs(network.id)" :key="ip.ip"
                                                :class="ip.is_active ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'"
                                                class="border-2 rounded p-2 text-center transition hover:shadow">
                                                <div class="flex items-center justify-center mb-0.5">
                                                    <i class="fas fa-circle text-xs mr-1" :class="ip.is_active ? 'text-green-500' : 'text-red-500'"></i>
                                                    <span class="font-mono text-xs font-semibold" :class="ip.is_active ? 'text-green-800' : 'text-red-800'">
                                                        {{ ip.ip.split('.').slice(-1)[0] }}
                                                    </span>
                                                </div>
                                                <div class="text-xs text-gray-600 truncate" :title="ip.ip">{{ ip.ip }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </transition>
                        </div>
                    </div>
                    <div v-if="networks.length === 0" class="bg-white rounded-lg shadow p-8 text-center">
                        <i class="fas fa-inbox text-gray-300 text-5xl mb-3"></i>
                        <h3 class="text-lg text-gray-600 mb-1">æš‚æ— ç½‘æ®µ</h3>
                        <p class="text-gray-500 text-sm">ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ ç½‘æ®µ"æŒ‰é’®å¼€å§‹æ·»åŠ </p>
                    </div>
                </div>
            </div>

            <!-- æ·»åŠ ç½‘æ®µæ¨¡æ€æ¡† -->
            <transition name="fade">
                <div v-if="showAddModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full p-5">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800">æ·»åŠ ç½‘æ®µ</h3>
                            <button @click="closeAddModal" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <form @submit.prevent="addNetwork">
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-1">ç½‘æ®µåç§° *</label>
                                    <input v-model="newNetwork.name" type="text" required placeholder="ä¾‹å¦‚: åŠå…¬åŒºç½‘ç»œ"
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-1">CIDR *</label>
                                    <input v-model="newNetwork.cidr" type="text" required placeholder="ä¾‹å¦‚: 192.168.1.0/24"
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <p class="text-xs text-gray-500 mt-1">æ”¯æŒæ ¼å¼: 192.168.1.0/24 æˆ– 10.0.0.0/8</p>
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-1">æè¿°</label>
                                    <textarea v-model="newNetwork.description" placeholder="å¯é€‰çš„æè¿°ä¿¡æ¯" rows="2"
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                            <div class="flex space-x-2 mt-4">
                                <button type="submit"
                                    class="flex-1 bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold py-2 rounded-lg transition">æ·»åŠ </button>
                                <button type="button" @click="closeAddModal"
                                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold py-2 rounded-lg transition">å–æ¶ˆ</button>
                            </div>
                        </form>
                    </div>
                </div>
            </transition>

            <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
            <transition name="fade">
                <div v-if="showChangePasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full p-5">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-800">ä¿®æ”¹å¯†ç </h3>
                            <button @click="closeChangePasswordModal" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <form @submit.prevent="handleChangePassword">
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-1">æ—§å¯†ç  *</label>
                                    <input v-model="passwordForm.oldPassword" type="password" required placeholder="è¯·è¾“å…¥æ—§å¯†ç "
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-1">æ–°å¯†ç  *</label>
                                    <input v-model="passwordForm.newPassword" type="password" required placeholder="è¯·è¾“å…¥æ–°å¯†ç "
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-semibold mb-1">ç¡®è®¤æ–°å¯†ç  *</label>
                                    <input v-model="passwordForm.confirmPassword" type="password" required placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
                                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </div>
                            </div>
                            <div class="flex space-x-2 mt-4">
                                <button type="submit"
                                    class="flex-1 bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold py-2 rounded-lg transition">ç¡®è®¤ä¿®æ”¹</button>
                                <button type="button" @click="closeChangePasswordModal"
                                    class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-semibold py-2 rounded-lg transition">å–æ¶ˆ</button>
                            </div>
                        </form>
                    </div>
                </div>
            </transition>

            <!-- ä¸»æœºæ‰«ææ¨¡æ€æ¡† - å…¨æ–°è®¾è®¡ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰ -->
            <transition name="fade">
                <div v-if="showHostScanModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-2 sm:p-4">
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto">
                        <!-- æ ‡é¢˜æ  -->
                        <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 px-4 sm:px-6 py-3 sm:py-4 sticky top-0 z-10">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2 sm:space-x-3">
                                    <div class="bg-white bg-opacity-20 p-1.5 sm:p-2 rounded-lg">
                                        <i class="fas fa-server text-white text-lg sm:text-xl"></i>
                                    </div>
                                    <div class="text-white">
                                        <h3 class="text-base sm:text-lg font-bold">ä¸»æœºæ‰«æå·¥å…·</h3>
                                        <p class="text-xs opacity-90 hidden sm:block">æ¢æµ‹ç›®æ ‡ä¸»æœºçš„ç«¯å£ã€ç³»ç»Ÿå’Œç½‘ç»œä¿¡æ¯</p>
                                    </div>
                                </div>
                                <button @click="closeHostScanModal" class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-1.5 sm:p-2 transition">
                                    <i class="fas fa-times text-lg sm:text-xl"></i>
                                </button>
                            </div>
                        </div>

                        <!-- ä¸»ä½“å†…å®¹ -->
                        <div class="p-3 sm:p-6">
                            <!-- æ‰«æé…ç½®åŒº -->
                            <div class="bg-white rounded-xl shadow-sm p-3 sm:p-5 mb-3 sm:mb-5">
                                <h4 class="text-xs sm:text-sm font-bold text-gray-700 mb-2 sm:mb-3 flex items-center">
                                    <i class="fas fa-cog text-indigo-500 mr-2"></i>
                                    æ‰«æé…ç½®
                                </h4>
                                <form @submit.prevent="executeHostScan">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 sm:gap-3">
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">ç›®æ ‡IPåœ°å€ *</label>
                                            <input v-model="hostScanForm.targetIp" type="text" required placeholder="ä¾‹å¦‚: 192.168.1.100"
                                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">èµ·å§‹ç«¯å£</label>
                                            <input v-model.number="hostScanForm.startPort" type="number" min="1" max="65535" required
                                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                placeholder="1">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-gray-600 mb-1">ç»“æŸç«¯å£</label>
                                            <input v-model.number="hostScanForm.endPort" type="number" min="1" max="65535" required
                                                class="w-full px-2 sm:px-3 py-1.5 sm:py-2 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                                placeholder="1024">
                                        </div>
                                    </div>
                                    <div class="mt-3 sm:mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0">
                                        <div class="text-xs text-gray-500">
                                            <p class="flex items-center mb-1">
                                                <i class="fas fa-lightbulb text-yellow-500 mr-1"></i>
                                                æ¨èç«¯å£èŒƒå›´: 1-1024 (å¸¸ç”¨æœåŠ¡)
                                            </p>
                                            <p class="text-gray-400 ml-4 hidden sm:block">
                                                ğŸ’¡ æç¤º: ä½¿ç”¨ sudo è¿è¡ŒæœåŠ¡å¯è·å¾—æ›´å‡†ç¡®çš„OSæ£€æµ‹
                                            </p>
                                        </div>
                                        <button type="submit" :disabled="hostScanStatus === 'scanning'"
                                            class="w-full sm:w-auto bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-4 sm:px-6 py-2 text-xs sm:text-sm font-bold rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed shadow-md">
                                            <i class="fas mr-2" :class="hostScanStatus === 'scanning' ? 'fa-spinner fa-spin' : 'fa-play'"></i>
                                            {{ hostScanStatus === 'scanning' ? 'æ‰«æä¸­...' : 'å¼€å§‹æ‰«æ' }}
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- æ‰«æç»“æœåŒº -->
                            <div v-if="hostScanStatus !== 'idle'" class="space-y-3 sm:space-y-4">
                                <!-- æ‰«æä¸­çŠ¶æ€ -->
                                <div v-if="hostScanStatus === 'scanning'" class="bg-white rounded-xl shadow-sm p-6 sm:p-8 text-center">
                                    <div class="inline-block relative">
                                        <div class="w-12 h-12 sm:w-16 sm:h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
                                    </div>
                                    <h4 class="text-gray-700 font-semibold mt-3 sm:mt-4 text-sm sm:text-base">æ­£åœ¨æ‰«æä¸»æœº...</h4>
                                    <p class="text-gray-500 text-xs sm:text-sm mt-1">æ‰«æç›®æ ‡: {{ hostScanForm.targetIp }}</p>
                                    <p class="text-gray-400 text-xs mt-1">ç«¯å£èŒƒå›´: {{ hostScanForm.startPort }} - {{ hostScanForm.endPort }}</p>
                                </div>

                                <!-- æ‰«æå®Œæˆ -->
                                <div v-if="hostScanStatus === 'completed'" class="space-y-3 sm:space-y-4">
                                    <!-- ä¸»æœºä¿¡æ¯å¡ç‰‡ -->
                                    <div class="bg-white rounded-xl shadow-sm p-3 sm:p-5">
                                        <h4 class="text-xs sm:text-sm font-bold text-gray-700 mb-3 sm:mb-4 flex items-center">
                                            <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                            ä¸»æœºä¿¡æ¯
                                        </h4>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 sm:gap-4">
                                            <!-- IPåœ°å€ -->
                                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-2.5 sm:p-3">
                                                <div class="text-xs text-blue-600 font-semibold mb-1">IPåœ°å€</div>
                                                <div class="text-xs sm:text-sm font-bold text-blue-900 break-all">{{ hostScanResult.ip || '-' }}</div>
                                            </div>
                                            <!-- ä¸»æœºåï¼ˆä»…åœ¨æœ‰å€¼æ—¶æ˜¾ç¤ºï¼‰ -->
                                            <div v-if="hostScanResult.hostname && hostScanResult.hostname !== 'æœªæ£€æµ‹åˆ°'"
                                                class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-2.5 sm:p-3">
                                                <div class="text-xs text-green-600 font-semibold mb-1">ä¸»æœºå</div>
                                                <div class="text-xs sm:text-sm font-bold text-green-900 break-all" :title="hostScanResult.hostname">
                                                    {{ hostScanResult.hostname }}
                                                </div>
                                            </div>
                                            <!-- æ“ä½œç³»ç»Ÿ -->
                                            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-2.5 sm:p-3"
                                                :class="hostScanResult.hostname && hostScanResult.hostname !== 'æœªæ£€æµ‹åˆ°' ? '' : 'sm:col-span-1 lg:col-span-2'">
                                                <div class="text-xs text-purple-600 font-semibold mb-1">æ“ä½œç³»ç»Ÿ</div>
                                                <div class="text-xs sm:text-sm font-bold text-purple-900 break-words" :title="hostScanResult.os_type">
                                                    {{ hostScanResult.os_type || 'Unknown' }}
                                                </div>
                                            </div>
                                            <!-- MACåœ°å€ -->
                                            <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-2.5 sm:p-3">
                                                <div class="text-xs text-orange-600 font-semibold mb-1">MACåœ°å€</div>
                                                <div class="text-xs font-bold text-orange-900 break-all">
                                                    {{ hostScanResult.mac_address || 'ä¸å¯ç”¨' }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ç«¯å£åˆ—è¡¨ -->
                                    <div class="bg-white rounded-xl shadow-sm p-3 sm:p-5">
                                        <div class="flex items-center justify-between mb-3 sm:mb-4">
                                            <h4 class="text-xs sm:text-sm font-bold text-gray-700 flex items-center">
                                                <i class="fas fa-network-wired text-green-500 mr-2"></i>
                                                å¼€æ”¾ç«¯å£
                                            </h4>
                                            <span class="bg-green-100 text-green-700 px-2 sm:px-3 py-1 rounded-full text-xs font-bold">
                                                {{ hostScanResult.total_ports || 0 }} ä¸ªç«¯å£
                                            </span>
                                        </div>
                                        <div v-if="hostScanResult.open_ports && hostScanResult.open_ports.length > 0"
                                            class="max-h-48 sm:max-h-64 overflow-y-auto">
                                            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-1.5 sm:gap-2">
                                                <div v-for="port in hostScanResult.open_ports" :key="port"
                                                    class="bg-gradient-to-br from-emerald-400 to-emerald-500 hover:from-emerald-500 hover:to-emerald-600 text-white rounded-lg p-1.5 sm:p-2 text-center shadow-sm hover:shadow-md transition cursor-pointer group"
                                                    :title="getPortServiceName(port)">
                                                    <div class="text-sm sm:text-base font-bold">{{ port }}</div>
                                                    <div class="text-xs opacity-90 truncate">{{ getPortServiceName(port) }}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div v-else class="text-center py-6 sm:py-8">
                                            <i class="fas fa-shield-alt text-gray-300 text-2xl sm:text-3xl mb-2"></i>
                                            <p class="text-gray-500 text-xs sm:text-sm">æœªå‘ç°å¼€æ”¾ç«¯å£</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- åˆå§‹æç¤º -->
                            <div v-if="hostScanStatus === 'idle'" class="bg-white rounded-xl shadow-sm p-8 sm:p-12 text-center">
                                <div class="inline-block p-4 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-full mb-4">
                                    <i class="fas fa-search text-indigo-600 text-4xl"></i>
                                </div>
                                <h4 class="text-gray-700 font-bold text-lg mb-2">å‡†å¤‡å¼€å§‹æ‰«æ</h4>
                                <p class="text-gray-500 text-sm">è¯·åœ¨ä¸Šæ–¹è¾“å…¥ç›®æ ‡IPåœ°å€å’Œç«¯å£èŒƒå›´ï¼Œç„¶åç‚¹å‡»"å¼€å§‹æ‰«æ"</p>
                            </div>
                        </div>

                        <!-- åº•éƒ¨æ“ä½œæ  -->
                        <div class="bg-gray-100 px-6 py-4 flex justify-between items-center border-t">
                            <p class="text-xs text-gray-500">
                                <i class="fas fa-clock mr-1"></i>
                                æ‰«ææ—¶é—´: {{ hostScanResult.scan_time ? new Date(hostScanResult.scan_time).toLocaleString('zh-CN') : '-' }}
                            </p>
                            <button @click="closeHostScanModal"
                                class="bg-gray-300 hover:bg-gray-400 text-gray-700 text-sm font-semibold px-5 py-2 rounded-lg transition">
                                <i class="fas fa-times text-xs mr-1"></i>
                                å…³é—­
                            </button>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- åŠ è½½æç¤º -->
            <div v-if="loading" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-40">
                <div class="bg-white rounded-lg p-5 shadow-2xl">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-spinner fa-spin text-purple-600 text-xl"></i>
                        <span class="text-gray-700 text-sm font-semibold">åŠ è½½ä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    isLoggedIn: false,
                    token: null,
                    loginLoading: false,
                    loginForm: { username: '', password: '' },
                    showChangePasswordModal: false,
                    passwordForm: { oldPassword: '', newPassword: '', confirmPassword: '' },
                    showHostScanModal: false,
                    hostScanForm: { targetIp: '', startPort: 1, endPort: 1024 },
                    hostScanStatus: 'idle', // idle, scanning, completed, error
                    hostScanResult: { ip: '', hostname: null, mac_address: null, os_type: null, open_ports: [], total_ports: 0, scan_time: null },
                    currentTaskId: null,
                    networks: [],
                    stats: { total_networks: 0, total_ips: 0, active_ips: 0, inactive_ips: 0 },
                    showAddModal: false,
                    newNetwork: { id: '', name: '', cidr: '', description: '' },
                    expandedNetworks: [],
                    networkDetails: {},
                    scanStatus: {},
                    portScanStatus: {},  // ç«¯å£æ‰«æçŠ¶æ€
                    filterStatus: {},
                    loading: false,
                    toasts: [],
                    toastId: 0,
                    confirmDialog: { show: false, message: '', onConfirm: () => {}, onCancel: () => {} },
                    isLoggingOut: false,
                    statsIntervalId: null
                }
            },
            mounted() {
                const storedToken = localStorage.getItem('token');
                if (storedToken) {
                    this.token = storedToken;
                    this.isLoggedIn = true;
                    this.checkNmapAvailability();
                    this.loadNetworks();
                    this.loadStats();
                    this.startStatsPolling();
                }
            },
            methods: {
                async checkNmapAvailability() {
                    try {
                        const response = await fetch('/api/check-nmap');
                        const data = await response.json();
                        if (!data.available) {
                            this.showToast('âš ï¸ nmapæœªå®‰è£…ï¼Œä¸»æœºè¯¦ç»†æ‰«æåŠŸèƒ½å°†å—é™', 'warning');
                            // æ˜¾ç¤ºæ›´è¯¦ç»†çš„å®‰è£…æç¤º
                            setTimeout(async () => {
                                await this.showConfirm(
                                    'nmapæœªå®‰è£…ï¼Œä¸»æœºè¯¦ç»†æ‰«æåŠŸèƒ½å°†å—é™ã€‚\n\n' +
                                    'âœ… ç½‘æ®µæ‰«æåŠŸèƒ½æ­£å¸¸ï¼ˆä½¿ç”¨pingæ£€æµ‹ï¼‰\n' +
                                    'âŒ ä¸»æœºè¯¦ç»†æ‰«æåŠŸèƒ½å—é™ï¼ˆéœ€è¦nmapï¼‰\n\n' +
                                    'å¦‚éœ€å®Œæ•´åŠŸèƒ½ï¼Œè¯·å®‰è£…nmapï¼š\n' +
                                    'macOS: brew install nmap\n' +
                                    'Ubuntu/Debian: sudo apt-get install nmap\n' +
                                    'CentOS/RHEL: sudo yum install nmap\n\n' +
                                    'å®‰è£…å®Œæˆåè¯·åˆ·æ–°é¡µé¢ã€‚\n\n' +
                                    'ğŸ’¡ æç¤º: ä½¿ç”¨ sudo è¿è¡ŒæœåŠ¡å¯ä»¥å¯ç”¨å®Œæ•´çš„OSæ£€æµ‹åŠŸèƒ½ã€‚'
                                );
                            }, 1500);
                        }
                    } catch (error) {
                        console.error('æ£€æŸ¥nmapå¤±è´¥:', error);
                    }
                },
                startStatsPolling() {
                    // æ¸…é™¤æ—§çš„å®šæ—¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (this.statsIntervalId) {
                        clearInterval(this.statsIntervalId);
                    }
                    // å¯åŠ¨æ–°çš„å®šæ—¶å™¨
                    this.statsIntervalId = setInterval(() => {
                        if (this.isLoggedIn && this.token) {
                            this.loadStats();
                        }
                    }, 30000);
                },
                stopStatsPolling() {
                    if (this.statsIntervalId) {
                        clearInterval(this.statsIntervalId);
                        this.statsIntervalId = null;
                    }
                },
                showToast(message, type = 'info') {
                    const id = this.toastId++;
                    this.toasts.push({ id, message, type });
                    setTimeout(() => this.removeToast(id), 3000);
                },
                removeToast(id) {
                    const index = this.toasts.findIndex(t => t.id === id);
                    if (index > -1) this.toasts.splice(index, 1);
                },
                showConfirm(message) {
                    return new Promise((resolve) => {
                        this.confirmDialog = {
                            show: true,
                            message,
                            onConfirm: () => resolve(true),
                            onCancel: () => resolve(false)
                        };
                    });
                },
                async handleLogin() {
                    this.loginLoading = true;
                    try {
                        const response = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.loginForm)
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.token = data.access_token;
                            localStorage.setItem('token', this.token);
                            this.isLoggedIn = true;
                            this.loginForm = { username: '', password: '' };
                            this.checkNmapAvailability();
                            await this.loadNetworks();
                            await this.loadStats();
                            this.startStatsPolling();
                            this.showToast('ç™»å½•æˆåŠŸ', 'success');
                        } else {
                            const error = await response.json();
                            this.showToast('ç™»å½•å¤±è´¥: ' + error.detail, 'error');
                        }
                    } catch (error) {
                        console.error('ç™»å½•å¤±è´¥:', error);
                        this.showToast('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                    } finally {
                        this.loginLoading = false;
                    }
                },
                async handleLogout(auto = false) {
                    // é˜²æ­¢é‡å¤æ‰§è¡Œé€€å‡º
                    if (this.isLoggingOut) return;
                    // å¦‚æœæ˜¯ç”¨æˆ·ä¸»åŠ¨é€€å‡ºï¼Œæ˜¾ç¤ºç¡®è®¤æ¡†
                    if (!auto) {
                        const confirmed = await this.showConfirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—?');
                        if (!confirmed) {
                            return;
                        }
                    }

                    this.isLoggingOut = true;

                    // åœæ­¢å®šæ—¶å™¨
                    this.stopStatsPolling();

                    // æ¸…é™¤çŠ¶æ€
                    this.token = null;
                    this.isLoggedIn = false;
                    localStorage.removeItem('token');
                    this.networks = [];
                    this.stats = { total_networks: 0, total_ips: 0, active_ips: 0, inactive_ips: 0 };

                    if (auto) {
                        this.showToast('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'warning');
                    } else {
                        this.showToast('å·²é€€å‡ºç™»å½•', 'info');
                    }

                    // é‡ç½®æ ‡å¿—
                    setTimeout(() => {
                        this.isLoggingOut = false;
                    }, 500);
                },
                async handleChangePassword() {
                    if (this.passwordForm.newPassword !== this.passwordForm.confirmPassword) {
                        this.showToast('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'warning');
                        return;
                    }
                    if (this.passwordForm.newPassword.length < 5) {
                        this.showToast('æ–°å¯†ç é•¿åº¦è‡³å°‘ä¸º5ä½', 'warning');
                        return;
                    }
                    this.loading = true;
                    try {
                        const response = await fetch('/api/change-password', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({
                                old_password: this.passwordForm.oldPassword,
                                new_password: this.passwordForm.newPassword
                            })
                        });
                        if (response.ok) {
                            this.showToast('å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
                            this.closeChangePasswordModal();
                        } else {
                            const error = await response.json();
                            this.showToast('ä¿®æ”¹å¤±è´¥: ' + error.detail, 'error');
                        }
                    } catch (error) {
                        console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
                        this.showToast('ä¿®æ”¹å¯†ç å¤±è´¥', 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                closeChangePasswordModal() {
                    this.showChangePasswordModal = false;
                    this.passwordForm = { oldPassword: '', newPassword: '', confirmPassword: '' };
                },
                closeHostScanModal() {
                    this.showHostScanModal = false;
                    // ä¸é‡ç½®æ•°æ®ï¼Œä¿ç•™æ‰«æç»“æœ
                },
                async executeHostScan() {
                    // éªŒè¯IPæ ¼å¼
                    const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
                    if (!ipPattern.test(this.hostScanForm.targetIp.trim())) {
                        this.showToast('è¯·è¾“å…¥æ­£ç¡®çš„IPåœ°å€æ ¼å¼', 'warning');
                        return;
                    }

                    // éªŒè¯ç«¯å£èŒƒå›´
                    if (this.hostScanForm.startPort > this.hostScanForm.endPort) {
                        this.showToast('èµ·å§‹ç«¯å£ä¸èƒ½å¤§äºç»“æŸç«¯å£', 'warning');
                        return;
                    }

                    this.hostScanStatus = 'scanning';
                    this.hostScanResult = { ip: '', hostname: null, mac_address: null, os_type: null, open_ports: [], total_ports: 0, scan_time: null };

                    try {
                        const ip = this.hostScanForm.targetIp.trim();
                        const url = `/api/scan-host?ip=${encodeURIComponent(ip)}`;
                        const response = await this.apiRequest(url, {
                            method: 'POST',
                            body: JSON.stringify({
                                start_port: this.hostScanForm.startPort,
                                end_port: this.hostScanForm.endPort
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.currentTaskId = data.task_id;
                            this.pollHostScanStatus();
                            this.showToast('ä¸»æœºæ‰«æä»»åŠ¡å·²å¯åŠ¨', 'info');
                        }
                    } catch (error) {
                        if (error.message !== 'Unauthorized') {
                            console.error('å¯åŠ¨ä¸»æœºæ‰«æå¤±è´¥:', error);
                            this.hostScanStatus = 'error';
                            this.showToast('å¯åŠ¨ä¸»æœºæ‰«æå¤±è´¥', 'error');
                        }
                    }
                },
                async pollHostScanStatus() {
                    const interval = setInterval(async () => {
                        try {
                            const response = await this.apiRequest(`/api/scan-host/${this.currentTaskId}`);
                            const status = await response.json();

                            if (status.status === 'completed') {
                                clearInterval(interval);
                                this.hostScanStatus = 'completed';
                                this.hostScanResult = status;
                                this.showToast(`æ‰«æå®Œæˆ! å‘ç° ${status.total_ports} ä¸ªå¼€æ”¾ç«¯å£`, 'success');
                            } else if (status.status === 'error') {
                                clearInterval(interval);
                                this.hostScanStatus = 'error';
                                this.showToast('æ‰«æå‡ºé”™: ' + (status.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                            }
                        } catch (error) {
                            clearInterval(interval);
                            if (error.message !== 'Unauthorized') {
                                console.error('è·å–æ‰«æçŠ¶æ€å¤±è´¥:', error);
                                this.hostScanStatus = 'error';
                            }
                        }
                    }, 2000);
                },
                async apiRequest(url, options = {}) {
                    const headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.token}`,
                        ...options.headers
                    };
                    const response = await fetch(url, { ...options, headers });
                    if (response.status === 401) {
                        // è‡ªåŠ¨é€€å‡ºï¼Œä¸æ˜¾ç¤ºç¡®è®¤æ¡†
                        this.handleLogout(true);
                        throw new Error('Unauthorized');
                    }
                    return response;
                },
                async loadNetworks() {
                    try {
                        const response = await this.apiRequest('/api/networks');
                        this.networks = await response.json();
                    } catch (error) {
                        if (error.message !== 'Unauthorized') {
                            console.error('åŠ è½½ç½‘æ®µå¤±è´¥:', error);
                        }
                    }
                },
                async loadStats() {
                    try {
                        const response = await this.apiRequest('/api/stats');
                        this.stats = await response.json();
                    } catch (error) {
                        if (error.message !== 'Unauthorized') {
                            console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                        }
                    }
                },
                async addNetwork() {
                    // å»é™¤ CIDR å­—æ®µçš„å‰åç©ºæ ¼
                    this.newNetwork.cidr = this.newNetwork.cidr.trim();

                    // éªŒè¯ CIDR æ ¼å¼
                    const cidrPattern = /^(\d{1,3}\.){3}\d{1,3}\/\d{1,2}$/;
                    if (!cidrPattern.test(this.newNetwork.cidr)) {
                        this.showToast('CIDRæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨ç±»ä¼¼ 192.168.1.0/24 çš„æ ¼å¼', 'warning');
                        return;
                    }

                    // éªŒè¯ IP åœ°å€éƒ¨åˆ†çš„æœ‰æ•ˆæ€§
                    const parts = this.newNetwork.cidr.split('/');
                    const ipParts = parts[0].split('.');
                    const mask = parseInt(parts[1]);

                    if (ipParts.some(part => parseInt(part) > 255 || parseInt(part) < 0) || mask < 0 || mask > 32) {
                        this.showToast('CIDRæ ¼å¼ä¸æ­£ç¡®ï¼ŒIPåœ°å€èŒƒå›´åº”ä¸º0-255ï¼Œæ©ç åº”ä¸º0-32', 'warning');
                        return;
                    }

                    this.loading = true;
                    try {
                        const response = await this.apiRequest('/api/networks', {
                            method: 'POST',
                            body: JSON.stringify(this.newNetwork)
                        });
                        if (response.ok) {
                            await this.loadNetworks();
                            await this.loadStats();
                            this.closeAddModal();
                            this.showToast('ç½‘æ®µæ·»åŠ æˆåŠŸ', 'success');
                        } else {
                            const error = await response.json();
                            this.showToast('æ·»åŠ å¤±è´¥: ' + error.detail, 'error');
                        }
                    } catch (error) {
                        if (error.message !== 'Unauthorized') {
                            console.error('æ·»åŠ ç½‘æ®µå¤±è´¥:', error);
                            this.showToast('æ·»åŠ ç½‘æ®µå¤±è´¥', 'error');
                        }
                    } finally {
                        this.loading = false;
                    }
                },
                async deleteNetwork(networkId) {
                    if (!(await this.showConfirm('ç¡®å®šè¦åˆ é™¤è¯¥ç½‘æ®µå—?'))) return;
                    this.loading = true;
                    try {
                        const response = await this.apiRequest(`/api/networks/${networkId}`, { method: 'DELETE' });
                        if (response.ok) {
                            await this.loadNetworks();
                            await this.loadStats();
                            this.showToast('ç½‘æ®µåˆ é™¤æˆåŠŸ', 'success');
                        }
                    } catch (error) {
                        if (error.message !== 'Unauthorized') {
                            console.error('åˆ é™¤ç½‘æ®µå¤±è´¥:', error);
                            this.showToast('åˆ é™¤ç½‘æ®µå¤±è´¥', 'error');
                        }
                    } finally {
                        this.loading = false;
                    }
                },
                async scanNetwork(networkId) {
                    this.scanStatus[networkId] = { status: 'scanning' };
                    try {
                        const response = await this.apiRequest(`/api/networks/${networkId}/scan`, { method: 'POST' });
                        if (response.ok) {
                            this.pollScanStatus(networkId);
                            this.showToast('æ‰«æä»»åŠ¡å·²å¯åŠ¨', 'info');
                        }
                    } catch (error) {
                        if (error.message !== 'Unauthorized') {
                            console.error('å¯åŠ¨æ‰«æå¤±è´¥:', error);
                            this.scanStatus[networkId] = { status: 'error' };
                            this.showToast('å¯åŠ¨æ‰«æå¤±è´¥', 'error');
                        }
                    }
                },
                async pollScanStatus(networkId) {
                    const interval = setInterval(async () => {
                        try {
                            const response = await this.apiRequest(`/api/networks/${networkId}/scan-status`);
                            const status = await response.json();
                            this.scanStatus[networkId] = status;
                            if (status.status === 'completed' || status.status === 'error') {
                                clearInterval(interval);
                                await this.loadStats();
                                if (this.expandedNetworks.includes(networkId)) {
                                    await this.loadNetworkDetail(networkId);
                                }
                                if (status.status === 'completed') {
                                    this.showToast(`æ‰«æå®Œæˆ! å‘ç° ${status.active} ä¸ªåœ¨çº¿IP`, 'success');
                                }
                            }
                        } catch (error) {
                            clearInterval(interval);
                            if (error.message !== 'Unauthorized') {
                                console.error('è·å–æ‰«æçŠ¶æ€å¤±è´¥:', error);
                            }
                        }
                    }, 2000);
                },
                getPortScanStatus(networkId, ip) {
                    const scanKey = `${networkId}:${ip}`;
                    return this.portScanStatus[scanKey]?.status || 'idle';
                },
                showPortScanModal(networkId, ipData) {
                    this.portScanForm.networkId = networkId;
                    this.portScanForm.targetIp = ipData.ip;
                    this.portScanForm.startPort = 1;
                    this.portScanForm.endPort = 1024;

                    // åŠ è½½å·²æœ‰çš„ç«¯å£æ•°æ®
                    this.portDetailsData = {
                        ip: ipData.ip,
                        open_ports: ipData.open_ports || []
                    };

                    // è®¾ç½®åˆå§‹çŠ¶æ€
                    if (ipData.ports_scanned && ipData.open_ports) {
                        this.currentPortScanStatus = 'completed';
                    } else {
                        this.currentPortScanStatus = 'idle';
                    }

                    this.showPortScanModal_visible = true;
                },
                closePortScanModal() {
                    this.showPortScanModal_visible = false;
                    this.portScanForm = { networkId: '', targetIp: '', startPort: 1, endPort: 1024 };
                    this.portDetailsData = { ip: '', open_ports: [] };
                    this.currentPortScanStatus = 'idle';
                },
                async executePortScan() {
                    // éªŒè¯ç«¯å£èŒƒå›´
                    if (this.portScanForm.startPort > this.portScanForm.endPort) {
                        this.showToast('èµ·å§‹ç«¯å£ä¸èƒ½å¤§äºç»“æŸç«¯å£', 'warning');
                        return;
                    }
                    if (this.portScanForm.startPort < 1 || this.portScanForm.endPort > 65535) {
                        this.showToast('ç«¯å£èŒƒå›´å¿…é¡»åœ¨ 1-65535 ä¹‹é—´', 'warning');
                        return;
                    }

                    const { networkId, targetIp, startPort, endPort } = this.portScanForm;
                    const scanKey = `${networkId}:${targetIp}`;

                    // è®¾ç½®æ‰«æçŠ¶æ€
                    this.currentPortScanStatus = 'scanning';
                    this.portScanStatus[scanKey] = { status: 'scanning' };
                    this.portDetailsData.open_ports = [];

                    try {
                        const response = await this.apiRequest(
                            `/api/networks/${networkId}/ips/${encodeURIComponent(targetIp)}/scan-ports`,
                            {
                                method: 'POST',
                                body: JSON.stringify({ start_port: startPort, end_port: endPort })
                            }
                        );
                        if (response.ok) {
                            this.pollPortScanStatus(networkId, targetIp);
                            this.showToast('ç«¯å£æ‰«æä»»åŠ¡å·²å¯åŠ¨', 'info');
                        }
                    } catch (error) {
                        if (error.message !== 'Unauthorized') {
                            console.error('å¯åŠ¨ç«¯å£æ‰«æå¤±è´¥:', error);
                            this.currentPortScanStatus = 'error';
                            this.portScanStatus[scanKey] = { status: 'error' };
                            this.showToast('å¯åŠ¨ç«¯å£æ‰«æå¤±è´¥', 'error');
                        }
                    }
                },
                async pollPortScanStatus(networkId, ip) {
                    const scanKey = `${networkId}:${ip}`;
                    const interval = setInterval(async () => {
                        try {
                            const response = await this.apiRequest(
                                `/api/networks/${networkId}/ips/${encodeURIComponent(ip)}/port-scan-status`
                            );
                            const status = await response.json();
                            this.portScanStatus[scanKey] = status;

                            if (status.status === 'completed' || status.status === 'error') {
                                clearInterval(interval);

                                // åˆ·æ–°ç½‘æ®µè¯¦æƒ…ä»¥è·å–æœ€æ–°çš„ç«¯å£æ•°æ®
                                if (this.expandedNetworks.includes(networkId)) {
                                    await this.loadNetworkDetail(networkId);
                                }

                                if (status.status === 'completed') {
                                    // æ›´æ–°å¼¹çª—ä¸­çš„ç«¯å£æ•°æ®
                                    this.currentPortScanStatus = 'completed';
                                    this.portDetailsData.open_ports = status.open_ports || [];

                                    const portCount = status.total_ports || 0;
                                    this.showToast(`ç«¯å£æ‰«æå®Œæˆ! å‘ç° ${portCount} ä¸ªå¼€æ”¾ç«¯å£`, 'success');
                                } else {
                                    this.currentPortScanStatus = 'error';
                                }
                            }
                        } catch (error) {
                            clearInterval(interval);
                            if (error.message !== 'Unauthorized') {
                                console.error('è·å–ç«¯å£æ‰«æçŠ¶æ€å¤±è´¥:', error);
                                this.currentPortScanStatus = 'error';
                            }
                        }
                    }, 2000);
                },
                getPortServiceName(port) {
                    const portServices = {
                        21: 'FTP',
                        22: 'SSH',
                        23: 'Telnet',
                        25: 'SMTP',
                        53: 'DNS',
                        80: 'HTTP',
                        110: 'POP3',
                        143: 'IMAP',
                        443: 'HTTPS',
                        445: 'SMB',
                        465: 'SMTPS',
                        587: 'SMTP',
                        993: 'IMAPS',
                        995: 'POP3S',
                        1433: 'MSSQL',
                        3306: 'MySQL',
                        3389: 'RDP',
                        5432: 'PostgreSQL',
                        5900: 'VNC',
                        6379: 'Redis',
                        8080: 'HTTP-Alt',
                        8443: 'HTTPS-Alt',
                        9200: 'Elasticsearch',
                        27017: 'MongoDB'
                    };
                    return portServices[port] || 'Unknown';
                },
                async toggleNetworkDetail(networkId) {
                    const index = this.expandedNetworks.indexOf(networkId);
                    if (index > -1) {
                        this.expandedNetworks.splice(index, 1);
                    } else {
                        this.expandedNetworks.push(networkId);
                        await this.loadNetworkDetail(networkId);
                    }
                },
                async loadNetworkDetail(networkId) {
                    try {
                        const response = await this.apiRequest(`/api/networks/${networkId}`);
                        const detail = await response.json();
                        this.networkDetails[networkId] = detail;
                    } catch (error) {
                        if (error.message !== 'Unauthorized') {
                            console.error('åŠ è½½ç½‘æ®µè¯¦æƒ…å¤±è´¥:', error);
                        }
                    }
                },
                getFilteredIPs(networkId) {
                    const detail = this.networkDetails[networkId];
                    if (!detail || !detail.ips) return [];
                    const filter = this.filterStatus[networkId] || 'all';
                    if (filter === 'active') return detail.ips.filter(ip => ip.is_active);
                    else if (filter === 'inactive') return detail.ips.filter(ip => !ip.is_active);
                    return detail.ips;
                },
                closeAddModal() {
                    this.showAddModal = false;
                    this.newNetwork = { id: '', name: '', cidr: '', description: '' };
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
